---
title: "Using characterize with tidymodels"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using_characterize_with_tidymodels}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r}
#| label: setup
#| include: false

library(tidymodels)
library(characterize)

# ------------------------------------------------------------------------------

tidymodels_prefer()
theme_set(theme_bw())
options(pillar.advice = FALSE, pillar.min_title_chars = Inf)
```


$$
y_{i} = \pi^{x_{i1} x_{i2}} \sqrt{ 2 x_{i3} } -
  sin^{-1}(x_{i4}) + \log(x_{i5}  + x_{i5}) -
  (x_{i9} / x_{i10}) \sqrt{x_{i7} / x_{i8}} -
  x_{i2} x_{i7} + \epsilon_{i}
$$

```{r}
#| label: data-setup
set.seed(4005)
sim_train <- 
  sim_regression(1000, method = "hooker_2004") %>% 
  bind_cols(sim_noise(1000, 50))
sim_rs <- vfold_cv(sim_train)
```


```{r}
#| label: cart
#| cache: true
cart_spec <- 
  decision_tree(cost_complexity = tune()) %>% 
  set_mode("regression")

ctrl <- control_grid(save_workflow = TRUE, extract = retain_characteristics)

cart_res <-
  cart_spec %>%
  tune_grid(
    outcome ~ .,
    resamples = sim_rs,
    grid = tibble(cost_complexity = 10 ^ seq(-4, -1, length.out = 20)),
    control = ctrl
  )
cart_res
```

```{r}
#| label: get-results
#| warning: false
model_char <- collect_characteristics(cart_res)
model_char

model_char %>% 
  ggplot(aes(cost_complexity, mean)) + 
  geom_point() + 
  geom_line(alpha = 1 / 2) + 
  facet_wrap(~ .metric, scales = "free_y") + 
  scale_x_log10() +
  labs(y = NULL)

```


```{r}
#| label: get-results-and-metrics
#| warning: false
metric_and_char <- collect_characteristics(cart_res, add_metrics = TRUE)
metric_and_char

metric_and_char %>% 
  ggplot(aes(cost_complexity, mean)) + 
  geom_point() + 
  geom_line(alpha = 1 / 2) + 
  facet_wrap(~ .metric, scales = "free_y") + 
  scale_x_log10()+
  labs(y = NULL)
```



```{r}
#| label: rmse-vs-vars
rmse_vs_vars <- collect_characteristics(cart_res, add_metrics = TRUE, wide = TRUE)
rmse_vs_vars

rmse_vs_vars %>%
  ggplot(aes(num_active_features, rmse)) + 
  geom_point() + 
  geom_line(alpha = 1 / 2) +
  geom_hline(yintercept = 0.55, lty = 2, col = "green")
```


```{r}
#| label: select

rmse_vs_vars %>% 
  filter(rmse <= 0.55) %>% 
  slice_min(num_active_features, n = 1)
```

